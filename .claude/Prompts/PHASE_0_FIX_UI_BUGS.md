# PHASE 0: Fix UI Bugs & Stabilize Existing Features

## üéØ OBJECTIVE
Fix broken pages (Machines, Models, RFQ History) and ensure basic CRUD operations work with Supabase.

---

## üìã CONTEXT

Project: RFQ AI System for EMS Manufacturing
Stack: Next.js 13 (App Router) + TypeScript + Supabase + shadcn/ui
Location: `D:\Projects\RFQ_AI_SYSTEM`

The UI was generated by BOLT.new but several pages have runtime errors and don't connect properly to Supabase.

---

## üîß TASKS

### Task 1: Fix Machines Page (`/machines`)

**File:** `app/(dashboard)/machines/page.tsx`

**Issues:**
- Page may crash on load
- CRUD operations not working
- MachineDialog component incomplete

**Requirements:**
1. Load machines from Supabase `machines` table
2. Implement Add/Edit/Delete functionality
3. Show loading skeleton while fetching
4. Handle errors with toast notifications
5. Confirm before delete (check if machine is used in `model_stations`)

**Expected UI:**
- Table view with columns: Code, Name, Category, UPH, Cycle Time, Actions
- Search/filter by category
- Add button opens dialog
- Edit/Delete in action column

---

### Task 2: Fix Models Page (`/models`)

**File:** `app/(dashboard)/models/page.tsx`

**Issues:**
- ModelCard component may have issues
- Station relationship not loading properly

**Requirements:**
1. Load models with customer & stations relations from Supabase
2. Each ModelCard shows: Customer, Code, Status, Board Types, Station Count
3. Click card ‚Üí navigate to `/models/[id]`
4. Add Model ‚Üí `/models/new` with full wizard

**Model Detail Page (`/models/[id]`):**
- Show model info + station list per board type
- Edit/Delete model
- Station management (add/remove/reorder)

---

### Task 3: Fix RFQ History Page (`/rfq`)

**File:** `app/(dashboard)/rfq/page.tsx`

**Issues:**
- Page structure incomplete
- No RFQ table in database yet

**Requirements:**
1. Create `rfq_requests` table migration (see schema below)
2. List all RFQ requests with status badges
3. Click row ‚Üí navigate to results if completed
4. Filter by status, customer, date range

**RFQ Table Schema:**
```sql
CREATE TABLE rfq_requests (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id uuid REFERENCES customers(id),
  model_name text NOT NULL,
  reference_model_id uuid REFERENCES models(id),
  target_uph integer,
  target_volume integer,
  notes text,
  status text DEFAULT 'draft', -- draft, processing, completed, failed
  input_method text, -- manual, upload, copy
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  completed_at timestamptz
);

CREATE TABLE rfq_stations (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  rfq_id uuid REFERENCES rfq_requests(id) ON DELETE CASCADE,
  board_type text NOT NULL,
  station_code text NOT NULL,
  sequence integer NOT NULL,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE rfq_results (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  rfq_id uuid REFERENCES rfq_requests(id) ON DELETE CASCADE,
  matched_model_id uuid REFERENCES models(id),
  similarity_score numeric,
  matched_stations jsonb,
  missing_stations jsonb,
  investment_breakdown jsonb,
  manpower_estimate jsonb,
  risk_assessment jsonb,
  created_at timestamptz DEFAULT now()
);
```

---

### Task 4: Create Missing API Functions

**File:** `lib/api/rfq.ts` (NEW)

```typescript
// Functions needed:
export const createRFQ = async (data: RFQInput) => {...}
export const getRFQs = async () => {...}
export const getRFQById = async (id: string) => {...}
export const updateRFQStatus = async (id: string, status: string) => {...}
export const deleteRFQ = async (id: string) => {...}
export const saveRFQStations = async (rfqId: string, stations: StationInput[]) => {...}
export const saveRFQResults = async (rfqId: string, results: ResultInput[]) => {...}
```

---

### Task 5: Fix Supabase RLS Policies

Ensure all tables have proper RLS policies for authenticated users:
- SELECT, INSERT, UPDATE, DELETE for authenticated role
- Add indexes for foreign keys

---

## ‚úÖ ACCEPTANCE CRITERIA

- [ ] Machines page loads without errors
- [ ] Can add/edit/delete machines
- [ ] Models page shows cards with correct data
- [ ] Model detail page shows stations grouped by board type
- [ ] RFQ History page lists all requests
- [ ] New RFQ wizard saves to database
- [ ] All CRUD operations show success/error toasts
- [ ] Loading states work correctly
- [ ] No TypeScript errors
- [ ] `npm run build` passes

---

## üöÄ HOW TO START

```bash
cd D:\Projects\RFQ_AI_SYSTEM
npm install
npm run dev
```

1. First run the new migration for `rfq_requests`, `rfq_stations`, `rfq_results`
2. Fix each page one by one
3. Test CRUD operations manually
4. Run `npm run build` to check for errors

---

## üìÅ FILES TO MODIFY/CREATE

```
app/(dashboard)/machines/page.tsx      # Fix
app/(dashboard)/models/page.tsx        # Fix
app/(dashboard)/models/[id]/page.tsx   # Fix
app/(dashboard)/models/new/page.tsx    # Fix
app/(dashboard)/rfq/page.tsx           # Fix/Create
components/machines/MachineDialog.tsx  # Fix
components/models/ModelCard.tsx        # Fix
lib/api/rfq.ts                         # Create
supabase/migrations/YYYYMMDD_rfq_tables.sql  # Create
```
